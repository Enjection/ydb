# Коллекции резервных копий

Коллекции резервных копий обеспечивают продвинутое решение для резервного копирования в YDB, которое организует полные и инкрементальные резервные копии в управляемые коллекции. Этот подход предназначен для производственных нагрузок, требующих эффективного аварийного восстановления и возможностей восстановления на момент времени.

## Что такое коллекции резервных копий? {#what-are-backup-collections}

Коллекция резервных копий — это именованный набор скоординированных резервных копий для выбранных таблиц базы данных. Коллекции организуют связанные резервные копии и обеспечивают их согласованное восстановление, предоставляя:

- **Эффективность**: Инкрементальные резервные копии захватывают только изменения с момента предыдущей резервной копии
- **Организацию**: Связанные резервные копии группируются в логические коллекции
- **Гибкость восстановления**: Позволяет восстановление на момент времени для любой резервной копии в цепочке
- **Автоматизацию**: SQL-основанный API для управления резервным копированием и планирования

## Основные концепции {#core-concepts}

### Коллекция резервных копий

Именованный контейнер, который группирует резервные копии для определенного набора таблиц базы данных. Коллекции обеспечивают согласованное резервное копирование всех включенных таблиц и их восстановление в один и тот же момент времени.

### Полная резервная копия

Полный снимок всех выбранных таблиц в определенный момент времени. Служит базовой линией для последующих инкрементальных резервных копий и содержит все данные, необходимые для независимого восстановления.

### Инкрементальная резервная копия

Захватывает только изменения (вставки, обновления, удаления) с момента предыдущей резервной копии в цепочке. Значительно меньше полных резервных копий для наборов данных с ограниченными изменениями.

### Цепочка резервных копий

Упорядоченная последовательность резервных копий, начинающаяся с полной резервной копии, за которой следует ноль или более инкрементальных резервных копий. Каждая инкрементальная резервная копия зависит от всех предыдущих резервных копий в цепочке для полного восстановления.

## Архитектура и компоненты {#architecture}

### Поток резервного копирования {#backup-flow}

1. **Создание коллекции**: Определение таблиц для включения и настроек хранения
2. **Начальная полная резервная копия**: Создание базового снимка всех таблиц
3. **Регулярные инкрементальные резервные копии**: Автоматический или ручной захват текущих изменений
4. **Управление цепочкой**: Мониторинг цепочек резервных копий и управление политиками хранения
5. **Восстановление на момент времени**: Восстановление в любую точку резервной копии в цепочке

### Структура хранения {#storage-structure}

Коллекции резервных копий хранятся в выделенной структуре каталогов в базе данных:

```text
/.backups/collections/
├── collection_name_1/
│   ├── backup_20240315_120000/     # Полная резервная копия
│   ├── backup_20240315_180000/     # Инкрементальная резервная копия
│   └── backup_20240316_060000/     # Инкрементальная резервная копия
├── collection_name_2/
│   └── backup_20240316_000000/     # Полная резервная копия
```

Каждая резервная копия содержит:

- Схемы таблиц на момент резервного копирования
- Файлы данных (полные или инкрементальные изменения)
- Метаданные для валидации цепочки и восстановления

### Бэкенды хранения {#storage-backends}

#### Кластерное хранилище

Резервные копии хранятся в самом кластере YDB, обеспечивая:

- **Высокую доступность**: Использует репликацию и отказоустойчивость кластера
- **Производительность**: Быстрые операции резервного копирования и восстановления
- **Интеграцию**: Бесшовную интеграцию с операциями кластера
- **Безопасность**: Использует механизмы безопасности кластера

```sql
WITH ( STORAGE = 'cluster' )
```

#### Внешнее хранилище (будущее)

Будущие версии могут поддерживать автоматический экспорт в системы внешнего хранения для долгосрочного архивирования. В настоящее время используйте [операции экспорта/импорта](../reference/ydb-cli/export-import/index.md) для внешнего хранения.

### Фоновые операции {#background-operations}

Все операции резервного копирования и восстановления выполняются асинхронно в фоновом режиме, позволяя:

- Продолжать обычные операции с базой данных во время резервного копирования
- Отслеживать прогресс через API длительных операций
- Обрабатывать большие наборы данных без блокировки других действий
- Планировать резервное копирование для оптимальных окон производительности

## Как работают коллекции резервных копий внутри {#how-they-work}

### Процесс создания резервной копии

1. **Изоляция транзакций**: Резервное копирование начинается с согласованной точки снимка
2. **Сканирование таблиц**: Каждая таблица сканируется на предмет данных и схемы
3. **Отслеживание изменений**: Для инкрементальных резервных копий захватываются только изменения с последней резервной копии
4. **Запись в хранилище**: Данные записываются в место хранения резервных копий
5. **Запись метаданных**: Метаданные резервной копии записываются для валидации цепочки

### Механизм инкрементального резервного копирования

Инкрементальные резервные копии используют отслеживание изменений для определения:

- **Новых строк**: Добавленных с последней резервной копии
- **Измененных строк**: Измененных данных в существующих строках  
- **Удаленных строк**: Удаленных данных (записи tombstone)
- **Изменений схемы**: Модификаций структуры таблиц

### Валидация цепочки и целостность

Система обеспечивает целостность цепочки резервных копий через:

- **Отслеживание зависимостей**: Каждая инкрементальная резервная копия записывает своего родителя
- **Проверки валидации**: Полнота цепочки проверяется перед операциями
- **Гарантии согласованности**: Все таблицы создаются из одной точки транзакции
- **Обнаружение ошибок**: Поврежденные или отсутствующие резервные копии определяются автоматически

## Связь с инкрементальными резервными копиями {#relationship-with-incremental-backups}

Коллекции резервных копий являются основой для функциональности инкрементального резервного копирования:

- **Коллекции разрешают инкрементальность**: Необходимо иметь коллекцию для создания инкрементальных резервных копий
- **Управление цепочкой**: Коллекции управляют последовательностью полных и инкрементальных резервных копий
- **Согласованность**: Все таблицы в коллекции создаются согласованно
- **Координация восстановления**: Восстановление применяет все резервные копии в правильном порядке

Без коллекций резервных копий доступны только операции полного экспорта/импорта.

## Когда использовать коллекции резервных копий {#when-to-use}

**Идеальные сценарии:**

- Производственные среды, требующие регулярного планирования резервного копирования
- Большие наборы данных, где инкрементальные изменения намного меньше общих данных
- Требования восстановления на момент времени
- Планирование аварийного восстановления с ограничениями RTO/RPO
- Автоматизированные рабочие процессы резервного копирования

**Рассмотрите традиционный экспорт/импорт для:**

- Небольших баз данных или отдельных таблиц
- Одноразовых задач миграции данных
- Сред разработки/тестирования
- Простых сценариев резервного копирования без инкрементальных потребностей
- Требований внешнего хранилища (до поддержки автоматического внешнего хранилища)

## Преимущества и ограничения {#benefits-limitations}

### Преимущества

- **Эффективность хранения**: Инкрементальные резервные копии используют значительно меньше места для хранения
- **Более быстрое резервное копирование**: После начальной полной резервной копии обрабатываются только изменения
- **Восстановление на момент времени**: Восстановление в любую точку резервной копии в цепочке
- **SQL интерфейс**: Знакомые SQL команды для управления резервным копированием
- **Фоновая обработка**: Неблокирующие операции
- **Целостность цепочки**: Автоматическая валидация и проверки согласованности

### Текущие ограничения

- **Только кластерное хранилище**: Внешнее хранилище требует ручного экспорта/импорта
- **Нет модификации коллекций**: Нельзя добавлять/удалять таблицы после создания
- **Единый бэкенд хранения**: Только 'cluster' хранилище поддерживается через SQL
- **Ограничения параллельности**: Множественные резервные копии одной коллекции могут конфликтовать

## Следующие шаги {#next-steps}

- **Начать работу**: Следуйте [руководству по операциям](../maintenance/manual/backup-collections.md) для пошаговых инструкций
- **Изучить команды**: Просмотрите [справочник по синтаксису YQL](../yql/reference/syntax/backup-collections.md) для полной документации команд
- **Посмотреть примеры**: Изучите [общие сценарии](../recipes/backup-collections.md) и лучшие практики

## См. также

- [Общие концепции резервного копирования](backup.md) - Обзор всех подходов резервного копирования в YDB
- [YQL команды резервного копирования](../yql/reference/syntax/backup-collections.md) - Полный справочник синтаксиса SQL
- [Руководство по операциям](../maintenance/manual/backup-collections.md) - Практические инструкции и примеры
- [Общие рецепты](../recipes/backup-collections.md) - Сценарии реального использования
